<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="gargle">
<title>Auth when using R in the browser • gargle</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.1.3/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.1.3/bootstrap.bundle.min.js"></script><link href="../deps/Source_Sans_Pro-0.4.2/font.css" rel="stylesheet">
<link href="../deps/Source_Code_Pro-0.4.2/font.css" rel="stylesheet">
<!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Auth when using R in the browser">
<meta property="og:description" content="gargle">
<meta name="robots" content="noindex">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><script defer data-domain="gargle.r-lib.org,all.tidyverse.org" src="https://plausible.io/js/plausible.js"></script>
</head>
<body>
    <a href="#container" class="visually-hidden-focusable">Skip to content</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-none"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">gargle</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">1.2.0.9002</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/non-interactive-auth.html">Non-interactive auth</a>
    <a class="dropdown-item" href="../articles/troubleshooting.html">Troubleshooting gargle auth</a>
    <a class="dropdown-item" href="../articles/auth-from-web.html">Auth when using R in the browser</a>
    <a class="dropdown-item" href="../articles/get-api-credentials.html">How to get your own API credentials</a>
    <div class="dropdown-divider"></div>
    <a class="dropdown-item" href="../articles/index.html">More articles...</a>
  </div>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-news">News</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-news">
    <h6 class="dropdown-header" data-toc-skip>Releases</h6>
    <a class="external-link dropdown-item" href="https://www.tidyverse.org/blog/2021/07/gargle-1-2-0/">gargle 1.2.0</a>
    <a class="external-link dropdown-item" href="https://www.tidyverse.org/blog/2019/08/gargle-hello-world/">gargle's debut on CRAN</a>
    <div class="dropdown-divider"></div>
    <a class="dropdown-item" href="../news/index.html">Changelog</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/r-lib/gargle/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article" id="container">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Auth when using R in the browser</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/r-lib/gargle/blob/HEAD/vignettes/auth-from-web.Rmd" class="external-link"><code>vignettes/auth-from-web.Rmd</code></a></small>
      <div class="d-none name"><code>auth-from-web.Rmd</code></div>
    </div>

    
    
<p>If you are working with R in a web-based context, such as <a href="https://www.rstudio.com/products/rstudio/download-server/" class="external-link">RStudio Server</a>, <a href="https://rstudio.cloud" class="external-link">RStudio Cloud</a>, or <a href="https://www.rstudio.com/products/workbench/" class="external-link">RStudio Workbench</a>, your experience of browser-based auth flows will be different from those using R on their local machine. You need to use <strong>out-of-band authentication</strong>, sometimes denoted “oob”. After the usual auth dance, instead of seeing “authentication successful, return to R!”, you are presented with an authorization code to copy and paste back into your R session.</p>
<p>The need to use oob auth can sometimes be detected automatically. For example, oob auth is always used when the httpuv package is not installed. gargle also tries to detect usage via RStudio Server, Cloud, or Workbench, but this still may not catch 100% of situations where oob auth is necessary.</p>
<p>Therefore, some users may still need to recognize this situation and explicitly request oob auth.</p>
<p>Here’s a typical presentation of this problem: during auth, you are redirected to localhost on port 1410 and receive an error along these lines:</p>
<pre><code>Chrome: This site can't be reached; localhost refused to connect.
Firefox: Unable to connect; can't establish a connection.</code></pre>
<p>This is a sign that you need to explicitly request oob auth.</p>
<p>This article describes how to do so in a package that uses gargle for auth, which includes:</p>
<ul>
<li>
<a href="https://bigrquery.r-dbi.org" class="external-link">bigrquery</a> (&gt;= v1.2.0)</li>
<li>
<a href="https://googledrive.tidyverse.org" class="external-link">googledrive</a> (&gt;= v1.0.0)</li>
<li>
<a href="https://gmailr.r-lib.org" class="external-link">gmailr</a> (&gt;= v1.0.0)</li>
<li><a href="https://googlesheets4.tidyverse.org" class="external-link">googlesheets4</a></li>
<li>
<a href="https://github.com/andrie/gcalendr" class="external-link">gcalendr</a> <em>GitHub only</em>
</li>
</ul>
<div class="section level2">
<h2 id="request-oob-auth-in-the-pkg_auth-call">Request oob auth in the <code>PKG_auth()</code> call<a class="anchor" aria-label="anchor" href="#request-oob-auth-in-the-pkg_auth-call"></a>
</h2>
<p>These packages aim to make auth “just work” for most users, i.e. it’s automatically triggered upon first need. However, it is always possible to initiate auth yourself, which gives you the opportunity to specify non-default values of certain parameters. Here’s how you request oob auth, using googledrive as an example:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://googledrive.tidyverse.org" class="external-link">googledrive</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu">drive_auth</span><span class="op">(</span>use_oob <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># now carry on with your work</span></span>
<span><span class="fu">drive_find</span><span class="op">(</span>n_max <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span></code></pre></div>
<p>This code is tailored to an interactive session and assumes that a user is present to respond. If you <em>also</em> need to setup a token for non-interactive use, see the article <a href="https://gargle.r-lib.org/articles/non-interactive-auth.html">Non-interactive auth</a>. A key point is that oob auth is relevant to how you <em>initially</em> obtain a token. It is orthogonal to downstream use and refreshing. So it is possible that you need to attend to both!</p>
</div>
<div class="section level2">
<h2 id="set-the-gargle_oob_default-option">Set the <code>gargle_oob_default</code> option<a class="anchor" aria-label="anchor" href="#set-the-gargle_oob_default-option"></a>
</h2>
<p>If you know that you <em>always</em> want to use oob auth, as a user or within a project, the best way to express this is to set the <code>gargle_oob_default</code> option.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>gargle_oob_default <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>This code could appear at the top of a script, in a setup chunk for <code>.Rmd</code>, or in a Shiny app. But it probably makes even more sense in a <code>.Rprofile</code> startup file, at the user- or project-level.</p>
<p>Once that option has been set, it is honoured by downstream calls to <code>PKG_auth()</code>, explicit or implicit, because the default behaviour of <code>use_oob</code> is to consult the option:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">drive_auth</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">email</span> <span class="op">=</span> <span class="fu">gargle</span><span class="fu">::</span><span class="fu"><a href="../reference/gargle_options.html">gargle_oauth_email</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                       <span class="va">path</span> <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>                       <span class="va">scopes</span> <span class="op">=</span> <span class="st">"https://www.googleapis.com/auth/drive"</span>,</span>
<span>                       <span class="va">cache</span> <span class="op">=</span> <span class="fu">gargle</span><span class="fu">::</span><span class="fu"><a href="../reference/gargle_options.html">gargle_oauth_cache</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                       <span class="va">use_oob</span> <span class="op">=</span> <span class="fu">gargle</span><span class="fu">::</span><span class="fu"><a href="../reference/gargle_options.html">gargle_oob_default</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                       <span class="va">token</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span><span class="va">...</span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="but-i-didnt-need-oob-yesterday">But I didn’t need oob yesterday!<a class="anchor" aria-label="anchor" href="#but-i-didnt-need-oob-yesterday"></a>
</h2>
<p>Sometimes the usual oauth web flow suddenly stops working for people working directly with R (so NOT via the browser) and they use oob auth to get unstuck again. What’s going on in this case?</p>
<p>The initial error looks something like this:</p>
<pre><code>createTcpServer: address already in use
Error in httpuv::startServer(use$host, use$port, list(call = listen)) : 
  Failed to create server</code></pre>
<p>It’s characteristic of some other process sitting on port 1410, which is what httr is trying to use for auth.</p>
<p>It’s true that using oob auth is a workaround. But oob auth is, frankly, more clunky, so why use if you don’t have to? Here are ways to fix.</p>
<ul>
<li>Restart your system. This will almost certainly kill the offending process, which is usually a zombie process.</li>
<li>Hunt down the offending process, verify it looks expendable, and kill it.</li>
</ul>
<p>On *nix-y systems, use <code>lsof</code> to get the process ID:</p>
<pre><code>sudo lsof -i :1410</code></pre>
<p>The output will look something like this:</p>
<pre><code>COMMAND   PID  USER   FD   TYPE            DEVICE SIZE/OFF NODE NAME
R       16664 jenny   20u  IPv4 0x63761a50856c65f      0t0  TCP localhost:hiq (LISTEN)</code></pre>
<p>In this case, as is typical, this is a zombie R process and I feel confident killing it. The process ID is listed there as PID. Note that and kill the process, like so, filling in the PID you found:</p>
<pre><code>kill -9 &lt;PID&gt;</code></pre>
<p>So, to be clear, in this example, the command would be:</p>
<pre><code>kill -9 16664</code></pre>
<p>The normal, non-oob auth web flow should work again now.</p>
</div>
<div class="section level2">
<h2 id="further-reading">Further reading<a class="anchor" aria-label="anchor" href="#further-reading"></a>
</h2>
<p>Generating OAuth tokens for a server using httr (<code>https://support.rstudio.com/hc/en-us/articles/217952868-Generating-OAuth-tokens-from-a-server</code>) covers some of the same ground, although for the httr package. gargle provides a Google-specific interface to httr. gargle first consults the <code>gargle_oob_default</code> option and, if that is undefined, also consults the <code>httr_oob_default</code> option.</p>
<p>If you’re creating content to be deployed (for example on <a href="https://www.shinyapps.io" class="external-link">shinyapps.io</a> or <a href="https://www.rstudio.com/products/connect/" class="external-link">RStudio Connect</a>), you will also need to consider how the <a href="https://gargle.r-lib.org/articles/non-interactive-auth.html">deployed content will authenticate non-interactively</a>.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



   </div>
  <footer><div class="container">
  <div class="pkgdown-footer-left">
  <p></p>
<p>Developed by <a href="https://jennybryan.org" class="external-link">Jennifer Bryan</a>, Craig Citro, <a href="http://hadley.nz" class="external-link">Hadley Wickham</a>, <a href="https://www.rstudio.com" class="external-link"><img src="https://www.tidyverse.org/rstudio-logo.svg" alt="RStudio" width="72"></a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

  </div></footer>
</body>
</html>
